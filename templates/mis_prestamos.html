{{define "title"}}Mis Pr√©stamos{{end}}

{{define "content"}}
<h2 class="mb-4 text-center">üìö Mis Pr√©stamos</h2>

<!-- ‚úÖ ALERTAS -->
{{if .Query.success}}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    ‚úÖ Pr√©stamo editado correctamente.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{{end}}

{{if .Query.error}}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{if eq .Query.error "mismo"}}‚ùå La nueva fecha no puede ser igual a la actual.{{end}}
    {{if eq .Query.error "incompleto"}}‚ö†Ô∏è Faltan datos para editar el pr√©stamo.{{end}}
    {{if eq .Query.error "ocupado"}}‚ùå Ya existe un pr√©stamo con esa fecha y libro.{{end}}
    {{if eq .Query.error "max_15_dias"}}‚ö†Ô∏è La fecha supera el l√≠mite de 15 d√≠as permitidos.{{end}}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{{end}}

{{if .Prestamos}}
  <div class="list-group">
    {{range .Prestamos}}
      <div class="list-group-item d-flex justify-content-between align-items-center shadow-sm mb-2 rounded">
        <div>
          <h5 class="mb-1 fw-bold">{{.Libro}}</h5>
          <small class="text-muted">Fecha del Pr√©stamo: {{.Fecha}}</small>
        </div>
        <div class="btn-group">
          <!-- ‚úÖ BOT√ìN EDITAR -->
          <button type="button"
                  class="btn btn-editar btn-sm btn-anim"
                  data-bs-toggle="modal"
                  data-bs-target="#editarModal"
                  data-id="{{.ID}}"
                  data-libro="{{.Libro}}"
                  data-fecha="{{.Fecha}}">
            ‚úèÔ∏è Editar
          </button>

          <!-- ‚úÖ BOT√ìN DEVOLVER -->
          <form method="POST" action="/devolver-prestamo" class="ms-2">
            <input type="hidden" name="id" value="{{.ID}}">
            <button type="submit" class="btn btn-devolver btn-sm btn-anim">üóëÔ∏è Devolver</button>
          </form>
        </div>
      </div>
    {{end}}
  </div>
{{else}}
  <p class="text-muted text-center">No tienes pr√©stamos registrados actualmente.</p>
{{end}}

<!-- ‚úÖ MODAL EDITAR -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="/editar-prestamo" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarModalLabel">Editar Pr√©stamo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Libro:</strong> <span id="modalLibro"></span></p>
        <p><strong>Fecha actual:</strong> <span id="modalFechaActual"></span></p>

        <div class="mb-3">
          <label for="modalFechaNueva" class="form-label">Nueva Fecha</label>
          <input type="date" class="form-control" id="modalFechaNueva" name="fecha" required>
        </div>

        <input type="hidden" name="id" id="modalPrestamoId">
        <input type="hidden" name="fecha_actual" id="modalFechaOculta">

        <div id="modalError" class="alert alert-danger d-none mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚úÖ ESTILOS PERSONALIZADOS -->
<style>
  .btn-anim {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-anim:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }

  .btn-editar {
    background-color: #86B879;  /* LIME LOLLIPOP */
    border: none;
    color: #fff;
  }
  .btn-editar:hover {
    background-color: #76A869;
    color: #fff;
  }

  .btn-devolver {
    background-color: #F297A0;  /* PRIMROSE GARDEN */
    border: none;
    color: #fff;
  }
  .btn-devolver:hover {
    background-color: #E1707B;
    color: #fff;
  }
</style>

<!-- ‚úÖ SCRIPT VALIDACI√ìN -->
<script>
  const editarModal = document.getElementById('editarModal');
  editarModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const libro = button.getAttribute('data-libro');
    const fecha = button.getAttribute('data-fecha');

    document.getElementById('modalPrestamoId').value = id;
    document.getElementById('modalLibro').textContent = libro;
    document.getElementById('modalFechaActual').textContent = fecha;
    document.getElementById('modalFechaNueva').value = '';
    document.getElementById('modalFechaOculta').value = fecha;
    document.getElementById('modalError').classList.add('d-none');

    const hoy = new Date().toISOString().split('T')[0];
    const max = new Date();
    max.setDate(max.getDate() + 15);
    const maxStr = max.toISOString().split('T')[0];
    document.getElementById('modalFechaNueva').setAttribute('min', hoy);
    document.getElementById('modalFechaNueva').setAttribute('max', maxStr);
  });

  const modalForm = editarModal.querySelector('form');
  modalForm.addEventListener('submit', function (event) {
    const fechaNueva = document.getElementById('modalFechaNueva').value;
    const fechaActual = document.getElementById('modalFechaOculta').value;

    if (fechaNueva === fechaActual) {
      event.preventDefault();
      const errorDiv = document.getElementById('modalError');
      errorDiv.textContent = '‚ùå La nueva fecha no puede ser igual a la fecha actual.';
      errorDiv.classList.remove('d-none');
      return;
    }

    const fechaNuevaDate = new Date(fechaNueva);
    const hoy = new Date();
    const max = new Date();
    max.setDate(max.getDate() + 15);

    if (fechaNuevaDate < hoy || fechaNuevaDate > max) {
      event.preventDefault();
      const errorDiv = document.getElementById('modalError');
      errorDiv.textContent = '‚ö†Ô∏è La nueva fecha debe estar dentro de los pr√≥ximos 15 d√≠as.';
      errorDiv.classList.remove('d-none');
    }
  });
</script>
{{end}}
